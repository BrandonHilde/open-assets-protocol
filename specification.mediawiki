<pre>
  Title: Colored Coin Protocol (CCP/1.0)
  Author: Flavien Charlon <flavien.charlon@pixode.net>
  Created: 12-12-2013
</pre>

==Abstract==

This document describes a protocol used for coloring outputs in the Blockchain.

Colored coins are initially issued using normal uncolored Bitcoins and marking them with a color. They can then be transferred using transactions that preserve the amount of coins of every color.

==Motivation==

In the current Bitcoin implementation, outputs have an output script and a value. Colored Coin Protocol adds the ability to have a color component to each output.

There are many applications to colored coins:

* A company could issue colored coins representing shares. The shares could then be traded fictionlessly through the Bitcoin infrastructure.
* A bank could issue colored coins backed by a cash reserve. People could withdraw and deposit money in colored coins, and trade those, or use them to pay for goods and services. The Blockchain becomes a system allowing to transact not only in Bitcoin, but in any currency.
* Locks on cars or houses could be associated to coins of a particular color. The door would only open when presented with a wallet containing a coin of that particular color.

==Protocol Overview==

Each output in the Blockchain can either be uncolored, or be tagged with a color. The color of an output has two components: the ''issue ID'' and the ''issuing script''.

The '''issue ID''' is the hash of the transaction that issued those colored coins. Coins with the same ''issue ID'' are interchangeable with each other. By construction, the supply of coins having a particular ''issue ID'' is fixed.

The '''issuing script''' of an output is, by convention, the output script referenced by the first input of the issuing transaction. When the ''issue ID'' of an output is known, it is easy to find the ''issuing script'' by looking up the issuing transaction by hash, and examining the first input. The ''issuing script'' is a representation of who issued the coins. Coins that have the same ''issuing script'' cannot be mixed together unless they also have the same ''issue ID''. The issuer can reissue new coins having the same ''issuing script'' as long as they retain the private key required to redeem that script.

In the typical use case, the ''issuing script'' would be a Pay-to-PubKey-Hash script. The issuer would create a script by generating an address and the matching private key. The private key is then used to issue coins with that particular ''issuing script''. This acts as a digital signature, and gives the guarantee that nobody else but the original issuer is able to issue coins with the same ''issuing script''.

When somebody issues colored coins, he typically associates them with a formal or informal promise that he will redeem the coins according to terms he has defined. That contract can be defined at multiple levels:
* At the issue level: the issuer would for example only commit to redeem coins issued by transactions listed on their website.
* At the issuing script level: the issuer could commit to redeem any coin that has a particular ''issuing script''.
* At an intermediate level: the issuer would commit to redeem coins that have a particular ''issuing script'', except if the issuing transaction appears on a list of repudiated issues.

The Colored Coins Protocol uses two types of transactions: one to issue colored coins, and one to transfer colored coins. Transactions that are not recognized as either of those two types are considered as having all their outputs uncolored.

==Colored Coins Transactions==

===Issuing colored coins===

Issuing new colored coins is done through a special transaction called issue transaction. The format of such transaction is described below:

{|
! Input/Output                     !! Description !! Color
|-
! Input 0                          || The output script referenced by this input becomes the ''issuing script'' of the coins being issued. || The referenced output can be of any color.
|-
! Input 1+                         || Any other inputs. || The referenced outputs can be of any color.
|-
! Outputs before the marker output || Colored outputs. || Considered colored.
|-
! Marker output                    || This output is the [[#colored-coins-marker-output|marker output]], it uses the OP_RETURN operator. || The output is neither colored nor uncolored since it is not spendable.
|-
! Outputs after the marker output  || Outputs used for change. || Considered uncolored.
|-
! Fees                             || Transaction fees left for the miners. || Considered uncolored.
|}

The marker output acts as a separator between colored outputs, which are before the marker, and uncolored outputs, which are after.

Colored outputs have the following characteristics:
* Their '''issue ID''' is the standard transaction hash of this transaction.
* Their '''issuing script''' is the output script referenced by the first input of this transaction.

===Color transfer===

Transfer transactions are used to send colored and uncolored coins. A transfer transaction is constructed as follow:

{|
! Input/Output !! Description
|-
! Input 0+     || Each input can be of any color, or uncolored. They do not need to have all the same color.
|-
! Output 0     || This output is the [[#colored-coins-marker-output|marker output]], it uses the OP_RETURN operator.
|-
! Output 1+    || Other outputs of the transaction.
|-
! Fees         || Transaction fees left for the miners. Considered uncolored.
|}

The [[#colored-coins-marker-output|marker output]] output uses the OP_RETURN operator to store data. It indicates to color-aware clients that this transaction is relevant for the Colored Coins Protocol.

If an output has the value of zero satoshis (this can be the case for the marker output), it is considered uncolored.

====Output coloring====

The ''issue ID'' of outputs are determined using a method called order based coloring.

The algorithm works by coloring outputs in the same order as inputs are colored, taking values into account. When an output is mapped to an input, the ''issue ID'' and ''issuing script'' of the output referenced by the input is carried to the output.

The boundaries where an input with a particular ''issue ID'' is followed by an input with a different ''issue ID'' should match boundaries between outputs. If any of the input boundary is not aligned with an output boundary, the transaction is deemed invalid according to the Colored Coins Protocol, and all the outputs are considered uncolored. Fees must be paid using uncolored coins for the transaction to be valid, and must come from the last inputs.

Clients modified to support the Colored Coins Protocol should reject transfer transactions that do not follow those rules.

====Example====

This is an example of a valid transfer transaction:

    =============================   =============================
    Input 0                         Output 0 - Marker output
      Value:          1               Value:          0
      Issue ID:       104cc329...     Issue ID:       <NULL>
      Issuing script: 76A914AA...     Issuing script: <NULL>
    -----------------------------   -----------------------------
    Input 1                         Output 1
      Value:          3               Value:          2
      Issue ID:       104cc329...     Issue ID:       104cc329...
      Issuing script: 76A914AA...     Issuing script: 76A914AA...
    =============================   -----------------------------
    Input 2                         Output 2
      Value:          1               Value:          2
      Issue ID:       2031d526...     Issue ID:       104cc329...
      Issuing script: 76A914BB...     Issuing script: 76A914AA...
    -----------------------------   =============================
    Input 3                         Output 3
      Value:          1               Value:          1
      Issue ID:       2031d526...     Issue ID:       2031d526...
      Issuing script: 76A914BB...     Issuing script: 76A914BB...
    =============================   =============================
    Input 4                         Fees
      Value:          2               Value:          2
      Issue ID:       <NULL>          Issue ID:       <NULL>
      Issuing script: <NULL>          Issuing script: <NULL>
    =============================   =============================

The inputs are grouped in contiguous blocks of inputs having the same ''issue ID'':
* The first two inputs form the first block, worth 4 Bitcoins and with the ''issue ID'' <code>104cc329...</code>.
* The next two inputs form a second block worth 2 Bitcoins with the ''issue ID'' <code>2031d526...</code>.
* The last input forms the third block worth 2 uncolored Bitcoins.

A similar grouping process is now performed on outputs, trying to form blocks of the same size as the input blocks:
* The first three inputs form the first block, worth 4 Bitcoins.
* The output 3 is the second block, worth 2 Bitcoin.
* Fees form the third block, worth 2 Bitcoins.

The boundaries formed by inputs and outputs match, since both inputs and outputs have in the same order blocks worth 4 Bitcoins, 2 Bitcoins and 2 Bitcoins, so the transaction is a valid transfer transaction.

The ''issue ID'' and ''issuing scripts'' are then sequentially carried from inputs to outputs:
* The first block of 3 outputs receives ''issue ID'' <code>104cc329...</code> and ''issuing script'' <code>76A914AA...</code>, except output 0 (the marker output) since it has a value of zero.
* Input 3 from the second block, receives ''issue ID'' <code>2031d526...</code> and ''issuing script'' <code>76A914BB...</code>.
* Finally, fees remain uncolored.

===Colored coins marker output===

Transactions relevant to the Colored Coins Protocol contain a special output called the marker output. The marker output is an OP_RETURN output followed by a header. The contents of the marker header is described below.

{|
! Field            !! Description !! Size
|-
! Length           || The var-integer encoded length of the marker header. Always 0x08.  || 1 byte
|-
! CCP Marker       || A marker indicating that this transaction is using Colored Coins Protocol. It is always 0x43435000. || 4 bytes
|-
! Version number   || The major revision number of the CCP protocol used. For this version, it is 1. || 2 bytes
|-
! Transaction type || 1 to indicate an issue transaction, or 2 to indicate a transfer transaction. || 2 bytes
|}

Additional optional metadata can be appended after the header. Possible formats for this metadata are outside of scope of this protocol, and may be described in separate protocol specifications building on top of this one.

==Rationale==

This approach offers a number of desirable characteristics:

# Economical: Neither the genesis process nor color transfer requires the parties to spend anything more than they want to transact, except for the usual transaction fee. This is because metadata is stored in an OP_RETURN output, which is not subject to the dust rule.
# Clients have a way to identify colored outputs simply by traversing the Blockchain, without needing to be fed external data. Transactions relevant to the Colored Coins Protocol are identified by the special marker output.
# Colors are pseudonymous. They are represented by a transaction hash (the ''issue ID'') or an output script (the ''issuing script''), which is enough to identify each color uniquely, while still providing an adequate level of anonymity.
# This approach uses the recommended way to embed data in the blockchain (OP_RETURN), and therefore does not pollute the UTXO.
# The whole cryptographic infrastructure that Bitcoin provides for securing the spending of outputs is reused for securing the ability to issue colored coins. There is a symmetry between ''an address + private key'' as a way to spend Bitcoins, and ''an address + private key'' as a way to issue colored coins.
# Generating a reissuable color based on an ''issuing script'' is as simple as generating an address, and can even be done offline.
# Reissuing coins of a given color is easy and can be done at no cost (except for the transaction fee) as long as the issuer keeps the matching private key.
# Single-issue colors can be achieved by only using the ''issue ID'' and ignoring the ''issuing script''.
# Since ''issuing scripts'' are not limited to Pay-to-PubKey-Hash script but can be any script, it is possible to create a color that requires multiple signatures for issuance.

==Compatibility==

For backward compatibility reasons, we consider than an older client is allowed to see a colored output as uncolored.

===Backward compatibility with existing Bitcoin protocol===

The Colored Coins Protocol sits on top of the Bitcoin protocol. It does not require any change to the existing Bitcoin protocol. Existing clients that don't support the colored coins protocol will see all outputs as uncolored, and will not be able to perform transfer transactions.

===Compatibility between different versions of CCP===

New versions with the same major version number (e.g. 1.1) should be backwards compatible, but may include new coloring algorithms. If they do so, older version will not recognize the transfer transactions created by newer clients, and using the new algorithm, but this is considered a valid behavior. Older clients may see some colored outputs as uncolored.

New versions with a different major version number (e.g. 2.0) can introduce breaking changes, but transactions created by newer clients will be identifiable by a different version number in the output 0 of genesis and transfer transactions.